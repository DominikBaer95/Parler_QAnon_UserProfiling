---
title: "Parler_Content_Modelling"
author: "Anonymous Author(s)"
date: "24 6 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# ##################################################################################################################
#    File analyses parleys (posts/comments)
# ##################################################################################################################

# Libraries

```{r library, include=FALSE}

library(tidyverse)
library(lubridate)
library(doParallel)
library(furrr)
library(caret)
library(broom)
library(tidytext)
library(stopwords)
library(wordcloud)
library(Rtsne)

## Functions
source("utils.R")

```

# Directories

```{r paths, include = FALSE}

# Input data
path_input <- "./../data/input/parleys_user"
# Output data
path_output <- "./../data/output/"
# Path figures
path_figures <- "./../doc/WWW 22 - User Identification/Submission/figures/"

```

# Load data

```{r load data, include=FALSE}

# User data
load(str_c(path_output, "data_qanon_user.Rdata"))

# User features
load(str_c(path_output, "features_user.Rdata"))

# User features
load(str_c(path_output, "features_linguistic.Rdata"))

# QAnon users
load(str_c(path_output, "user_qanon.Rdata"))

# Transform qIndicator to factor
features_all_unalterd <- features_user %>%
  left_join(features_linguistic, by = c("creator", "qIndicator")) %>%
  mutate(qIndicator = factor(qIndicator, levels = c(0, 1), labels = c("non.QAnon", "QAnon")))

# Remove "q" from stopwords
stop <- stop_words[stop_words$word != "q", ]

```

# Important variables

```{r}

# Set seed
set.seed(1234)

```

# Feature names

```{r}

# Vector with feature names
names_features_user <- c("account_age", "user_followers", "user_following" , "user_posts", "user_comments", "freq_upvotes_posts", "freq_impressions", "freq_upvotes_comments", "freq_downvotes_comments")
names_features_stylistic <- c("freq_handle_user", "freq_hash_user", "freq_pos_user", "freq_long_words_user", "freq_urls", "user_sentiment")
names_features_text <- str_c("text", c(0:383))
names_features_all <- c(names_features_user, names_features_stylistic, names_features_text)

```

# Parallel Processing

```{r}

plan(multisession, workers = 5)

```

# Descriptive statistics

## User data

### Total number of observations (users)

```{r, echo = FALSE}

# Number of users
# Overall
nrow(features_all_unalterd)

# by QAnon
features_all_unalterd %>%
  group_by(qIndicator) %>%
  summarize(n())

# Number of posts
# Overall
descriptives_data <- features_all_unalterd %>%
  summarize(n_followers = sum(user_followers, na.rm = TRUE),
            n_following = sum(user_following, na.rm = TRUE),
            n_posts = sum(user_posts, na.rm = TRUE),
            n_comments = sum(user_comments, na.rm = TRUE),
            n_upvotes_posts = sum(n_upvotes_posts, na.rm = TRUE),
            n_impressions = sum(n_impressions, na.rm = TRUE),
            n_upvotes_comments = sum(n_upvotes_comments, na.rm = TRUE),
            n_downvotes_comments = sum(n_downvotes_comments, na.rm = TRUE),
            n_users = n()) %>%
  mutate(across(.cols = everything(), ~ .x/n_users, .names = "rel_{.col}"))

descriptives_export <- descriptives_data %>%
  select(starts_with("n_")) %>%
  t() %>%
  as.data.frame() %>%
  cbind(descriptives_data %>% select(starts_with("rel_")) %>% t() %>% as.data.frame())

# by QAnon
features_all_unalterd %>%
  group_by(qIndicator) %>%
  summarize(n_posts = sum(user_posts, na.rm = TRUE),
            n_comments = sum(user_comments, na.rm = TRUE))


```

```{r}

# Posts with hashtags
nrow(parleys %>% filter(str_detect(body, pattern = "#"))) / nrow(parleys)

```

```{r}
# Example Bios
bios_example <- data_qanon_user %>%
  group_by(qIndicator) %>%
  select(qIndicator, bio) %>%
  filter(!str_detect(bio, pattern = "[^\x01-\x7F]")) %>%
  slice_sample(n = 5)
  
```


### Followers, Following, Posts, Comments, Likes

#### Overvall

```{r, include=FALSE}

# Descriptive statistics for user features
descriptives_user <- features_all_unalterd %>%
  select(all_of(names_features_user)) %>%
  summarize(across(.fns = list(Min = min, Mean = mean, Median = median, Max = max, Sd = sd), na.rm = TRUE, .names = "{.fn}b{.col}")) %>%
  data.frame(.) %>%
  mutate_if(is.numeric, round, digits = 2) %>% 
  pivot_longer(cols = everything(),
               names_to = c("set", ".value"),
               names_pattern = "(.+)b(.*)")

# Descriptive statistics for stylistic features
descriptives_stylistic <- features_all_unalterd %>%
  select(all_of(names_features_stylistic)) %>%
  summarize(across(.fns = list(Min = min, Mean = mean, Median = median, Max = max, Sd = sd), na.rm = TRUE, .names = "{.fn}b{.col}")) %>%
  data.frame(.) %>%
  mutate_if(is.numeric, round, digits = 2) %>% 
  pivot_longer(cols = everything(),
               names_to = c("set", ".value"),
               names_pattern = "(.+)b(.*)")

```

#### QAnon vs. Non-QAnon

```{r, include=FALSE}

# Descriptive statistics for user features
descriptives_user_by_qanon <- features_all_unalterd %>%
  select(all_of(names_features_user), qIndicator) %>%
  group_by(qIndicator) %>%
  summarize(across(.fns = list(Min = min, Mean = mean, Median = median, Max = max, Sd = sd), na.rm = TRUE, .names = "{.fn}b{.col}")) %>%
  data.frame(.) %>%
  mutate_if(is.numeric, round, digits = 2) %>% 
  pivot_longer(cols = c(-qIndicator),
               names_to = c("set", ".value"),
               names_pattern = "(.+)b(.*)")

# Interquartile range account age
features_all_unalterd %>%
  select(qIndicator, account_age) %>%
  group_by(qIndicator) %>%
  summarize(iqr_75 = quantile(account_age, 0.75),
            iqr_25 = quantile(account_age, 0.25))

# Descriptive statistics for stylistic features
descriptives_stylistic_by_qanon <- features_all_unalterd %>%
  select(all_of(names_features_stylistic), qIndicator) %>%
  group_by(qIndicator) %>%
  summarize(across(.fns = list(Min = min, Mean = mean, Median = median, Max = max, Sd = sd), na.rm = TRUE, .names = "{.fn}b{.col}")) %>%
  data.frame(.) %>%
  mutate_if(is.numeric, round, digits = 2) %>% 
  pivot_longer(cols = c(-qIndicator),
               names_to = c("set", ".value"),
               names_pattern = "(.+)b(.*)")

```

### Kolmogorov-Smirnov Test

```{r}

# KS test combined features
df_ks_user_full <- features_all_unalterd %>%
  select(qIndicator, all_of(names_features_user)) %>%
  pivot_longer(cols = -qIndicator)

df_ks_linguistic_full <- features_all_unalterd %>%
  select(qIndicator, all_of(names_features_stylistic)) %>%
  pivot_longer(cols = -qIndicator)
  
ks_user_full <- ks.test(df_ks_user_full %>% dplyr::filter(qIndicator == "QAnon") %>% pull(value),
                        df_ks_user_full %>% dplyr::filter(qIndicator != "QAnon") %>% pull(value))

ks_linguistic_full <- ks.test(df_ks_linguistic_full %>% dplyr::filter(qIndicator == "QAnon") %>% pull(value),
                              df_ks_linguistic_full %>% dplyr::filter(qIndicator != "QAnon") %>% pull(value))

# KS-Test user features
ks_user <- vector(mode = "list", length = length(names_features_user))
names(ks_user) <- names_features_user

for (i in 1:length(names_features_user)) {
  ks_user[[i]] <- ks.test(features_all_unalterd %>% dplyr::filter(qIndicator == "QAnon") %>% pull(names_features_user[i]),
                          features_all_unalterd %>% dplyr::filter(qIndicator != "QAnon") %>% pull(names_features_user[i])) %>%
    tidy() %>% mutate(label = paste0("KS-test: D=", round(statistic, 3), ", p<", format(round(p.value, digits = 3), nsmall = 2)))
}

map(ks_user, ~ print(.x[["label"]]))

# KS-Test stylisitc features
ks_stylistic <- vector(mode = "list", length = length(names_features_stylistic))
names(ks_stylistic) <- names_features_stylistic

for (i in 1:length(names_features_stylistic)) {
  ks_stylistic[[i]] <- ks.test(features_all_unalterd %>% dplyr::filter(qIndicator == "QAnon") %>% pull(names_features_stylistic[i]),
                               features_all_unalterd %>% dplyr::filter(qIndicator != "QAnon") %>% pull(names_features_stylistic[i])) %>%
    tidy() %>% mutate(label = ifelse(p.value < 0.01, paste0("KS-test: D=", round(statistic, 3), ", p<0.01"),                                                             
                                     paste0("KS-test: D=", round(statistic, 3), ", p<", format(round(p.value, digits = 2), nsmall = 2))))
}

map(ks_stylistic, ~ print(.x[["label"]]))

```

### Complementary cumulative distribution functions

```{r}

theme_set(
  theme_bw() +
    theme(legend.position = c(0.78, 0.9),
          legend.title = element_blank(), legend.direction="vertical",
          legend.text = element_text(colour="black", size=24), 
          legend.background=element_rect(fill="transparent", colour=NA),
          legend.key = element_rect(fill = "transparent", colour = "transparent"),
          legend.key.width = unit(1.25, "cm"), legend.key.height = unit(1.25, "cm")
    ) + 
    theme(axis.text.x=element_text(colour = "black", size=24, vjust=0.5), 
          axis.text.y=element_text(colour = "black", size=24, vjust=0.5),
          axis.title.x=element_text(size=24), 
          axis.title.y=element_text(size=24, vjust=1.5)
    ) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
)

```

# User features

## CCDF: Account Age

```{r, include = FALSE}

df_plot <- features_all_unalterd %>% group_by(qIndicator) %>% group_modify(~ ccdf(.x$account_age)) %>% arrange(x) %>% 
  mutate(y = lag(y, default = 1)) %>% ungroup()

plot_stat <- ks.test(features_all_unalterd %>% dplyr::filter(qIndicator == "QAnon") %>% pull(account_age), 
                     features_all_unalterd %>% dplyr::filter(qIndicator != "QAnon") %>% pull(account_age)) %>% 
  tidy() %>% mutate(label = ifelse(p.value < 0.01, paste0("KS-test: D=", round(statistic, 3), ", p<0.01"),
                                                            paste0("KS-test: D=", round(statistic, 3), ", p<", format(round(p.value, digits = 2), nsmall = 2))))

plot_ccdf <- ggplot(df_plot, aes(x = x, y = y, group=qIndicator)) + geom_line(aes(group = qIndicator, color=qIndicator, linetype = qIndicator), size = 1.5) +
  scale_colour_manual(values=c("#003893", "#CE1126", "#56B4E9"), labels= c("Non-QAnon", "QAnon")) +
  scale_linetype_discrete(labels= c("Non-QAnon", "QAnon")) + 
  scale_y_continuous(
    labels = c("0.001", "0.01", "0.1", "1", "10", "100"),
    trans = "log10",
    breaks = c(0.00001, 0.0001, 0.001, 0.01, 0.1, 1),
    limits = c(0.00001,1),
    expand = c(0, 0)
  )  +
  annotate(geom = "text", x = 220, y = 0.0000175, label = plot_stat$label, parse = F, size = 6) +
  labs(y = "CCDF (%)", x = "Account age") + 
  theme(plot.margin=grid::unit(c(5,7,2,5), "mm"))

plot_ccdf
ggsave(plot_ccdf, file = str_c(path_figures, "account_age_ccdf.pdf"), width = 20, height = 15, units = "cm")

```

## CCDF: Followers

```{r, include = FALSE}

df_plot <- features_all_unalterd %>% group_by(qIndicator) %>% group_modify(~ ccdf(.x$user_followers)) %>% arrange(x) %>% 
  mutate(y = lag(y, default = 1)) %>% ungroup()

plot_stat <- ks.test(features_all_unalterd %>% dplyr::filter(qIndicator == "QAnon") %>% pull(user_followers), 
                     features_all_unalterd %>% dplyr::filter(qIndicator != "QAnon") %>% pull(user_followers)) %>% 
  tidy() %>% mutate(label = ifelse(p.value < 0.01, paste0("KS-test: D=", round(statistic, 3), ", p<0.01"),
                                                            paste0("KS-test: D=", round(statistic, 3), ", p<", format(round(p.value, digits = 2), nsmall = 2))))

plot_ccdf <- ggplot(df_plot, aes(x = x, y = y, group=qIndicator)) + geom_line(aes(group = qIndicator, color=qIndicator, linetype = qIndicator), size = 1.5) +
  scale_colour_manual(values=c("#003893", "#CE1126", "#56B4E9"), labels= c("Non-QAnon", "QAnon")) +
  scale_linetype_discrete(labels= c("Non-QAnon", "QAnon")) + 
  scale_x_continuous(
    trans = "log10" ,
    breaks = c(1:10, seq(20,100,10), seq(200, 1000, 100), seq(2000, 10000, 1000), seq(20000, 100000, 10000), seq(200000, 1000000, 100000), seq(2000000, 10000000, 1000000)),
     labels = c(1, rep("", 8), 10, rep("", 8), 100, rep("", 8), 1000, rep("", 8), "10K", rep("", 8), "100K", rep("", 8), "1Mio", rep("", 8), "10Mio"),
    limits = c(1, 16000000),
    expand = c(0, 0)
  ) +
  scale_y_continuous(
    labels = c("0.001", "0.01", "0.1", "1", "10", "100"),
    trans = "log10",
    breaks = c(0.00001, 0.0001, 0.001, 0.01, 0.1, 1),
    limits = c(0.00001,1),
    expand = c(0, 0)
  )  +
  annotate(geom = "text", x = 180, y = 0.0000175, label = plot_stat$label, parse = F, size = 8) +
  labs(y = "CCDF (%)", x = "Followers") + 
  theme(plot.margin=grid::unit(c(5,7,2,5), "mm"))

plot_ccdf
ggsave(plot_ccdf, file = str_c(path_figures, "user_followers_ccdf.pdf"), width = 20, height = 15, units = "cm")

```

## CCDF: Followees

```{r, include = FALSE}

df_plot <- features_all_unalterd %>% group_by(qIndicator) %>% group_modify(~ ccdf(.x$user_following)) %>% arrange(x) %>% 
  mutate(y = lag(y, default = 1)) %>% ungroup()
plot_stat <- ks.test(features_all_unalterd %>% dplyr::filter(qIndicator == "QAnon") %>% pull(user_following), 
                     features_all_unalterd %>% dplyr::filter(qIndicator != "QAnon") %>% pull(user_following)) %>% 
  tidy() %>% mutate(label = ifelse(p.value < 0.01, paste0("KS-test: D=", round(statistic, 3), ", p<0.01"),
                                                            paste0("KS-test: D=", round(statistic, 3), ", p<", format(round(p.value, digits = 2), nsmall = 2))))

plot_ccdf <- ggplot(df_plot, aes(x = x, y = y, group=qIndicator)) + geom_line(aes(group = qIndicator, color=qIndicator, linetype = qIndicator), size = 1.5) +
  scale_colour_manual(values=c("#003893", "#CE1126", "#56B4E9"), labels= c("Non-QAnon", "QAnon")) +
  scale_linetype_discrete(labels= c("Non-QAnon", "QAnon")) + 
  scale_x_continuous(
    trans = "log10" ,
    breaks = c(1:10, seq(20,100,10), seq(200, 1000, 100), seq(2000, 10000, 1000), seq(20000, 100000, 10000), seq(200000, 1000000, 100000), seq(2000000, 10000000, 1000000)),
     labels = c(1, rep("", 8), 10, rep("", 8), 100, rep("", 8), 1000, rep("", 8), "10K", rep("", 8), "100K", rep("", 8), "1Mio", rep("", 8), "10Mio"),
    limits = c(1, 1100000),
    expand = c(0, 0)
  ) +
  scale_y_continuous(
    labels = c("0.001", "0.01", "0.1", "1", "10", "100"),
    trans = "log10",
    breaks = c(0.00001, 0.0001, 0.001, 0.01, 0.1, 1),
    limits = c(0.00001,1),
    expand = c(0, 0)
  )  +
  annotate(geom = "text", x = 80, y = 0.0000175, label = plot_stat$label, parse = F, size = 8) +
  labs(y = "CCDF (%)", x = "Following") + 
  theme(plot.margin=grid::unit(c(5,7,2,5), "mm"))

plot_ccdf
ggsave(plot_ccdf, file = str_c(path_figures, "user_following_ccdf.pdf"), width = 20, height = 15, units = "cm")

```

## CCDF: Posts

```{r, include = FALSE}

df_plot <- features_all_unalterd %>% group_by(qIndicator) %>% group_modify(~ ccdf(.x$user_posts)) %>% arrange(x) %>% 
  mutate(y = lag(y, default = 1)) %>% ungroup()

plot_stat <- ks.test(features_all_unalterd %>% dplyr::filter(qIndicator == "QAnon") %>% pull(user_posts), 
                     features_all_unalterd %>% dplyr::filter(qIndicator != "QAnon") %>% pull(user_posts)) %>% 
  tidy() %>% mutate(label = ifelse(p.value < 0.01, paste0("KS-test: D=", round(statistic, 3), ", p<0.01"),                                                             
                                   paste0("KS-test: D=", round(statistic, 3), ", p<", format(round(p.value, digits = 2), nsmall = 2))))

plot_ccdf <- ggplot(df_plot, aes(x = x, y = y, group=qIndicator)) + geom_line(aes(group = qIndicator, color=qIndicator, linetype = qIndicator), size = 1.5) +
  scale_colour_manual(values=c("#003893", "#CE1126", "#56B4E9"), labels= c("Non-QAnon", "QAnon")) +
  scale_linetype_discrete(labels= c("Non-QAnon", "QAnon")) + 
  scale_x_continuous(
    trans = "log10" ,
    breaks = c(1:10, seq(20,100,10), seq(200, 1000, 100), seq(2000, 10000, 1000), seq(20000, 100000, 10000), seq(200000, 1000000, 100000), seq(2000000, 10000000, 1000000)),
     labels = c(1, rep("", 8), 10, rep("", 8), 100, rep("", 8), 1000, rep("", 8), "10K", rep("", 8), "100K", rep("", 8), "1Mio", rep("", 8), "10Mio"),
    limits = c(1, 1100000),
    expand = c(0, 0)
  ) +
  scale_y_continuous(
    labels = c("0.001", "0.01", "0.1", "1", "10", "100"),
    trans = "log10",
    breaks = c(0.00001, 0.0001, 0.001, 0.01, 0.1, 1),
    limits = c(0.00001,1),
    expand = c(0, 0)
  )  +
  annotate(geom = "text", x = 80, y = 0.0000175, label = plot_stat$label, parse = F, size = 8) +
  labs(y = "CCDF (%)", x = "Posts") + 
  theme(plot.margin=grid::unit(c(5,7,2,5), "mm"))

plot_ccdf
ggsave(plot_ccdf, file = str_c(path_figures, "posts_ccdf.pdf"), width = 20, height = 15, units = "cm")

```

## CCDF: Coments

```{r, include = FALSE}

df_plot <- features_all_unalterd %>% group_by(qIndicator) %>% group_modify(~ ccdf(.x$user_comments)) %>% arrange(x) %>% 
  mutate(y = lag(y, default = 1)) %>% ungroup()

plot_stat <- ks.test(features_all_unalterd %>% dplyr::filter(qIndicator == "QAnon") %>% pull(user_comments), 
                     features_all_unalterd %>% dplyr::filter(qIndicator != "QAnon") %>% pull(user_comments)) %>% 
  tidy() %>% mutate(label = ifelse(p.value < 0.01, paste0("KS-test: D=", round(statistic, 3), ", p<0.01"),                                                             
                                   paste0("KS-test: D=", round(statistic, 3), ", p<", format(round(p.value, digits = 2), nsmall = 2))))

plot_ccdf <- ggplot(df_plot, aes(x = x, y = y, group=qIndicator)) + geom_line(aes(group = qIndicator, color=qIndicator, linetype = qIndicator), size = 1.5) +
  scale_colour_manual(values=c("#003893", "#CE1126", "#56B4E9"), labels= c("Non-QAnon", "QAnon")) +
  scale_linetype_discrete(labels= c("Non-QAnon", "QAnon")) + 
  scale_x_continuous(
    trans = "log10" ,
    breaks = c(1:10, seq(20,100,10), seq(200, 1000, 100), seq(2000, 10000, 1000), seq(20000, 100000, 10000), seq(200000, 1000000, 100000), seq(2000000, 10000000, 1000000)),
     labels = c(1, rep("", 8), 10, rep("", 8), 100, rep("", 8), 1000, rep("", 8), "10K", rep("", 8), "100K", rep("", 8), "1Mio", rep("", 8), "10Mio"),
    limits = c(1, 120000),
    expand = c(0, 0)
  ) +
  scale_y_continuous(
    labels = c("0.001", "0.01", "0.1", "1", "10", "100"),
    trans = "log10",
    breaks = c(0.00001, 0.0001, 0.001, 0.01, 0.1, 1),
    limits = c(0.00001,1),
    expand = c(0, 0)
  )  +
  annotate(geom = "text", x = 40, y = 0.0000175, label = plot_stat$label, parse = F, size = 8) +
  labs(y = "CCDF (%)", x = "Comments") + 
  theme(plot.margin=grid::unit(c(5,7,2,5), "mm"))

plot_ccdf
ggsave(plot_ccdf, file = str_c(path_figures, "comments_ccdf.pdf"), width = 20, height = 15, units = "cm")

```

## CCDF: Upvotes posts

```{r, include = FALSE}

df_plot <- features_all_unalterd %>% group_by(qIndicator) %>% group_modify(~ ccdf(.x$freq_upvotes_posts)) %>% arrange(x) %>% 
  mutate(y = lag(y, default = 1)) %>% ungroup()

plot_stat <- ks.test(features_all_unalterd %>% dplyr::filter(qIndicator == "QAnon") %>% pull(freq_upvotes_posts), 
                     features_all_unalterd %>% dplyr::filter(qIndicator != "QAnon") %>% pull(freq_upvotes_posts)) %>% 
  tidy() %>% mutate(label = ifelse(p.value < 0.01, paste0("KS-test: D=", round(statistic, 3), ", p<0.01"),                                                             
                                   paste0("KS-test: D=", round(statistic, 3), ", p<", format(round(p.value, digits = 2), nsmall = 2))))

plot_ccdf <- ggplot(df_plot, aes(x = x, y = y, group=qIndicator)) + geom_line(aes(group = qIndicator, color=qIndicator, linetype = qIndicator), size = 1.5) +
  scale_colour_manual(values=c("#003893", "#CE1126", "#56B4E9"), labels= c("Non-QAnon", "QAnon")) +
  scale_linetype_discrete(labels= c("Non-QAnon", "QAnon")) + 
  scale_x_continuous(
    trans = "log10" ,
    breaks = c(1:10, seq(20,100,10), seq(200, 1000, 100), seq(2000, 10000, 1000), seq(20000, 100000, 10000), seq(200000, 1000000, 100000), seq(2000000, 10000000, 1000000)),
     labels = c(1, rep("", 8), 10, rep("", 8), 100, rep("", 8), 1000, rep("", 8), "10K", rep("", 8), "100K", rep("", 8), "1Mio", rep("", 8), "10Mio"),
    limits = c(1, 20000),
    expand = c(0, 0)
  ) +
  scale_y_continuous(
    labels = c("0.001", "0.01", "0.1", "1", "10", "100"),
    trans = "log10",
    breaks = c(0.00001, 0.0001, 0.001, 0.01, 0.1, 1),
    limits = c(0.00001,1),
    expand = c(0, 0)
  )  +
  annotate(geom = "text", x = 23, y = 0.0000175, label = plot_stat$label, parse = F, size = 8) +
  labs(y = "CCDF (%)", x = "Upvotes (posts)") + 
  theme(plot.margin=grid::unit(c(5,7,2,5), "mm"))

plot_ccdf
ggsave(plot_ccdf, file = str_c(path_figures, "upvotes_posts_ccdf.pdf"), width = 20, height = 15, units = "cm")

```

## CCDF: Upvotes comments

```{r, include = FALSE}

df_plot <- features_all_unalterd %>% group_by(qIndicator) %>% group_modify(~ ccdf(.x$freq_upvotes_comments)) %>% arrange(x) %>% 
  mutate(y = lag(y, default = 1)) %>% ungroup()

plot_stat <- ks.test(features_all_unalterd %>% dplyr::filter(qIndicator == "QAnon") %>% pull(freq_upvotes_comments), 
                     features_all_unalterd %>% dplyr::filter(qIndicator != "QAnon") %>% pull(freq_upvotes_comments)) %>% 
  tidy() %>% mutate(label = ifelse(p.value < 0.01, paste0("KS-test: D=", round(statistic, 3), ", p<0.01"),                                                             
                                   paste0("KS-test: D=", round(statistic, 3), ", p<", format(round(p.value, digits = 2), nsmall = 2))))

plot_ccdf <- ggplot(df_plot, aes(x = x, y = y, group=qIndicator)) + geom_line(aes(group = qIndicator, color=qIndicator, linetype = qIndicator), size = 1.5) +
  scale_colour_manual(values=c("#003893", "#CE1126", "#56B4E9"), labels= c("Non-QAnon", "QAnon")) +
  scale_linetype_discrete(labels= c("Non-QAnon", "QAnon")) + 
  scale_x_continuous(
    trans = "log10" ,
    breaks = c(1:10, seq(20,100,10), seq(200, 1000, 100), seq(2000, 10000, 1000), seq(20000, 100000, 10000), seq(200000, 1000000, 100000), seq(2000000, 10000000, 1000000)),
     labels = c(1, rep("", 8), 10, rep("", 8), 100, rep("", 8), 1000, rep("", 8), "10K", rep("", 8), "100K", rep("", 8), "1Mio", rep("", 8), "10Mio"),
    limits = c(1, 1100),
    expand = c(0, 0)
  ) +
  scale_y_continuous(
    labels = c("0.001", "0.01", "0.1", "1", "10", "100"),
    trans = "log10",
    breaks = c(0.00001, 0.0001, 0.001, 0.01, 0.1, 1),
    limits = c(0.00001,1),
    expand = c(0, 0)
  )  +
  annotate(geom = "text", x = 9, y = 0.0000175, label = plot_stat$label, parse = F, size = 8) +
  labs(y = "CCDF (%)", x = "Upvotes (comments)") + 
  theme(plot.margin=grid::unit(c(5,7,2,5), "mm"))

plot_ccdf
ggsave(plot_ccdf, file = str_c(path_figures, "upvotes_comments_ccdf.pdf"), width = 20, height = 15, units = "cm")

```

## CCDF: Impressions

```{r, include = FALSE}

df_plot <- features_all_unalterd %>% group_by(qIndicator) %>% group_modify(~ ccdf(.x$freq_impressions)) %>% arrange(x) %>% 
  mutate(y = lag(y, default = 1)) %>% ungroup()

plot_stat <- ks.test(features_all_unalterd %>% dplyr::filter(qIndicator == "QAnon") %>% pull(freq_impressions), 
                     features_all_unalterd %>% dplyr::filter(qIndicator != "QAnon") %>% pull(freq_impressions)) %>% 
  tidy() %>% mutate(label = ifelse(p.value < 0.01, paste0("KS-test: D=", round(statistic, 3), ", p<0.01"),                                                             
                                   paste0("KS-test: D=", round(statistic, 3), ", p<", format(round(p.value, digits = 2), nsmall = 2))))

plot_ccdf <- ggplot(df_plot, aes(x = x, y = y, group=qIndicator)) + geom_line(aes(group = qIndicator, color=qIndicator, linetype = qIndicator), size = 1.5) +
  scale_colour_manual(values=c("#003893", "#CE1126", "#56B4E9"), labels= c("Non-QAnon", "QAnon")) +
  scale_linetype_discrete(labels= c("Non-QAnon", "QAnon")) + 
  scale_x_continuous(
    trans = "log10" ,
    breaks = c(1:10, seq(20,100,10), seq(200, 1000, 100), seq(2000, 10000, 1000), seq(20000, 100000, 10000), seq(200000, 1000000, 100000), seq(2000000, 10000000, 1000000)),
     labels = c(1, rep("", 8), 10, rep("", 8), 100, rep("", 8), 1000, rep("", 8), "10K", rep("", 8), "100K", rep("", 8), "1Mio", rep("", 8), "10Mio"),
    limits = c(1, 5000000),
    expand = c(0, 0)
  ) +
  scale_y_continuous(
    labels = c("0.001", "0.01", "0.1", "1", "10", "100"),
    trans = "log10",
    breaks = c(0.00001, 0.0001, 0.001, 0.01, 0.1, 1),
    limits = c(0.00001,1),
    expand = c(0, 0)
  )  +
  annotate(geom = "text", x = 100, y = 0.0000175, label = plot_stat$label, parse = F, size = 8) +
  labs(y = "CCDF (%)", x = "Impressions (posts)") + 
  theme(plot.margin=grid::unit(c(5,7,2,5), "mm"))

plot_ccdf
ggsave(plot_ccdf, file = str_c(path_figures, "impressions_ccdf.pdf"), width = 20, height = 15, units = "cm")

```

## CCDF: Downvotes

```{r, include = FALSE}

df_plot <- features_all_unalterd %>% group_by(qIndicator) %>% group_modify(~ ccdf(.x$freq_downvotes_comments)) %>% arrange(x) %>% 
  mutate(y = lag(y, default = 1)) %>% ungroup()

plot_stat <- ks.test(features_all_unalterd %>% dplyr::filter(qIndicator == "QAnon") %>% pull(freq_downvotes_comments), 
                     features_all_unalterd %>% dplyr::filter(qIndicator != "QAnon") %>% pull(freq_downvotes_comments)) %>% 
  tidy() %>% mutate(label = ifelse(p.value < 0.01, paste0("KS-test: D=", round(statistic, 3), ", p<0.01"),                                                             
                                   paste0("KS-test: D=", round(statistic, 3), ", p<", format(round(p.value, digits = 2), nsmall = 2))))

plot_ccdf <- ggplot(df_plot, aes(x = x, y = y, group=qIndicator)) + geom_line(aes(group = qIndicator, color=qIndicator, linetype = qIndicator), size = 1.5) +
  scale_colour_manual(values=c("#003893", "#CE1126", "#56B4E9"), labels= c("Non-QAnon", "QAnon")) +
  scale_linetype_discrete(labels= c("Non-QAnon", "QAnon")) + 
  scale_x_continuous(
    limits = c(0, 50),
    expand = c(0, 0)
    ) +
  scale_y_continuous(
    labels = c("0.001", "0.01", "0.1", "1", "10", "100"),
    trans = "log10",
    breaks = c(0.00001, 0.0001, 0.001, 0.01, 0.1, 1),
    limits = c(0.00001,1),
    expand = c(0, 0)
  )  +
  annotate(geom = "text", x = 16, y = 0.0000175, label = plot_stat$label, parse = F, size = 8) +
  labs(y = "CCDF (%)", x = "Downvotes (comments)") + 
  theme(plot.margin=grid::unit(c(5,7,2,5), "mm"))

plot_ccdf
ggsave(plot_ccdf, file = str_c(path_figures, "downvotes_ccdf.pdf"), width = 20, height = 15, units = "cm")

```

# Stylistic features
## CCDF: Handles

```{r, include = FALSE}

df_plot <- features_all_unalterd %>% group_by(qIndicator) %>% group_modify(~ ccdf(.x$freq_handle_user)) %>% arrange(x) %>% 
  mutate(y = lag(y, default = 1)) %>% ungroup()

plot_stat <- ks.test(features_all_unalterd %>% dplyr::filter(qIndicator == "QAnon") %>% pull(freq_handle_user), 
                     features_all_unalterd %>% dplyr::filter(qIndicator != "QAnon") %>% pull(freq_handle_user)) %>% 
  tidy() %>% mutate(label = ifelse(p.value < 0.01, paste0("KS-test: D=", round(statistic, 3), ", p<0.01"),                                                             
                                   paste0("KS-test: D=", round(statistic, 3), ", p<", format(round(p.value, digits = 2), nsmall = 2))))

plot_ccdf <- ggplot(df_plot, aes(x = x, y = y, group=qIndicator)) + geom_line(aes(group = qIndicator, color=qIndicator, linetype = qIndicator), size = 1.5) +
  scale_colour_manual(values=c("#003893", "#CE1126", "#56B4E9"), labels= c("Non-QAnon", "QAnon")) +
  scale_linetype_discrete(labels= c("Non-QAnon", "QAnon")) + 
  scale_x_continuous(
    expand = c(0, 0)
  ) +
  scale_y_continuous(
    labels = c("0.001", "0.01", "0.1", "1", "10", "100"),
    trans = "log10",
    breaks = c(0.00001, 0.0001, 0.001, 0.01, 0.1, 1),
    limits = c(0.00001,1),
    expand = c(0, 0)
  )  +
  annotate(geom = "text", x = 25, y = 0.0000175, label = plot_stat$label, parse = F, size = 8) +
  labs(y = "CCDF (%)", x = "Handles") + 
  theme(plot.margin=grid::unit(c(5,7,2,5), "mm"))

plot_ccdf
ggsave(plot_ccdf, file = str_c(path_figures, "freq_handle_user_ccdf.pdf"), width = 20, height = 15, units = "cm")

```

## CCDF: Hashtags

```{r, include = FALSE}

df_plot <- features_all_unalterd %>% group_by(qIndicator) %>% group_modify(~ ccdf(.x$freq_hash_user)) %>% arrange(x) %>% 
  mutate(y = lag(y, default = 1)) %>% ungroup()

plot_stat <- ks.test(features_all_unalterd %>% dplyr::filter(qIndicator == "QAnon") %>% pull(freq_hash_user), 
                     features_all_unalterd %>% dplyr::filter(qIndicator != "QAnon") %>% pull(freq_hash_user)) %>% 
  tidy() %>% mutate(label = ifelse(p.value < 0.01, paste0("KS-test: D=", round(statistic, 3), ", p<0.01"),                                                             
                                   paste0("KS-test: D=", round(statistic, 3), ", p<", format(round(p.value, digits = 2), nsmall = 2))))

plot_ccdf <- ggplot(df_plot, aes(x = x, y = y, group=qIndicator)) + geom_line(aes(group = qIndicator, color=qIndicator, linetype = qIndicator), size = 1.5) +
  scale_colour_manual(values=c("#003893", "#CE1126", "#56B4E9"), labels= c("Non-QAnon", "QAnon")) +
  scale_linetype_discrete(labels= c("Non-QAnon", "QAnon")) + 
  scale_x_continuous(
    expand = c(0, 0)
      ) +
  scale_y_continuous(
    labels = c("0.001", "0.01", "0.1", "1", "10", "100"),
    trans = "log10",
    breaks = c(0.00001, 0.0001, 0.001, 0.01, 0.1, 1),
    limits = c(0.00001,1),
    expand = c(0, 0)
  )  +
  annotate(geom = "text", x = 27, y = 0.0000175, label = plot_stat$label, parse = F, size = 8) +
  labs(y = "CCDF (%)", x = "Hashtags") + 
  theme(plot.margin=grid::unit(c(5,7,2,5), "mm"))

plot_ccdf
ggsave(plot_ccdf, file = str_c(path_figures, "freq_hash_user_ccdf.pdf"), width = 20, height = 15, units = "cm")

```

## CCDF: POS

```{r, include = FALSE}

df_plot <- features_all_unalterd %>% group_by(qIndicator) %>% group_modify(~ ccdf(.x$freq_pos_user)) %>% arrange(x) %>% 
  mutate(y = lag(y, default = 1)) %>% ungroup()

plot_stat <- ks.test(features_all_unalterd %>% dplyr::filter(qIndicator == "QAnon") %>% pull(freq_pos_user), 
                     features_all_unalterd %>% dplyr::filter(qIndicator != "QAnon") %>% pull(freq_pos_user)) %>% 
  tidy() %>% mutate(label = ifelse(p.value < 0.01, paste0("KS-test: D=", round(statistic, 3), ", p<0.01"),                                                             
                                   paste0("KS-test: D=", round(statistic, 3), ", p<", format(round(p.value, digits = 2), nsmall = 2))))

plot_ccdf <- ggplot(df_plot, aes(x = x, y = y, group=qIndicator)) + geom_line(aes(group = qIndicator, color=qIndicator, linetype = qIndicator), size = 1.5) +
  scale_colour_manual(values=c("#003893", "#CE1126", "#56B4E9"), labels= c("Non-QAnon", "QAnon")) +
  scale_linetype_discrete(labels= c("Non-QAnon", "QAnon")) + 
  scale_x_continuous(
    expand = c(0, 0)
      ) +
  scale_y_continuous(
    labels = c("0.001", "0.01", "0.1", "1", "10", "100"),
    trans = "log10",
    breaks = c(0.00001, 0.0001, 0.001, 0.01, 0.1, 1),
    limits = c(0.00001,1),
    expand = c(0, 0)
  )  +
  annotate(geom = "text", x = 58, y = 0.0000175, label = plot_stat$label, parse = F, size = 8) +
  labs(y = "CCDF (%)", x = "POS") + 
  theme(plot.margin=grid::unit(c(5,7,2,5), "mm"))

plot_ccdf
ggsave(plot_ccdf, file = str_c(path_figures, "freq_pos_user_ccdf.pdf"), width = 20, height = 15, units = "cm")

```

## CCDF: Long Words

```{r, include = FALSE}

df_plot <- features_all_unalterd %>% group_by(qIndicator) %>% group_modify(~ ccdf(.x$freq_long_words_user)) %>% arrange(x) %>% 
  mutate(y = lag(y, default = 1)) %>% ungroup()

plot_stat <- ks.test(features_all_unalterd %>% dplyr::filter(qIndicator == "QAnon") %>% pull(freq_long_words_user), 
                     features_all_unalterd %>% dplyr::filter(qIndicator != "QAnon") %>% pull(freq_long_words_user)) %>% 
  tidy() %>% mutate(label = ifelse(p.value < 0.01, paste0("KS-test: D=", round(statistic, 3), ", p<0.01"),                                                             
                                   paste0("KS-test: D=", round(statistic, 3), ", p<", format(round(p.value, digits = 2), nsmall = 2))))

plot_ccdf <- ggplot(df_plot, aes(x = x, y = y, group=qIndicator)) + geom_line(aes(group = qIndicator, color=qIndicator, linetype = qIndicator), size = 1.5) +
  scale_colour_manual(values=c("#003893", "#CE1126", "#56B4E9"), labels= c("Non-QAnon", "QAnon")) +
  scale_linetype_discrete(labels= c("Non-QAnon", "QAnon")) + 
  scale_x_continuous(
    limits = c(0, 75),
    expand = c(0, 0)
  ) +
  scale_y_continuous(
    labels = c("0.001", "0.01", "0.1", "1", "10", "100"),
    trans = "log10",
    breaks = c(0.00001, 0.0001, 0.001, 0.01, 0.1, 1),
    #labels = c(0.05, 0.1, 0.5, 1),
    limits = c(0.00001,1),
    expand = c(0, 0)
  )  +
  annotate(geom = "text", x = 24, y = 0.0000175, label = plot_stat$label, parse = F, size = 8) +
  labs(y = "CCDF (%)", x = "Long words") + 
  theme(plot.margin=grid::unit(c(5,7,2,5), "mm"))

plot_ccdf
ggsave(plot_ccdf, file = str_c(path_figures, "freq_longwords_user_ccdf.pdf"), width = 20, height = 15, units = "cm")

```

## CCDF: URL

```{r, include = FALSE}

df_plot <- features_all_unalterd %>% group_by(qIndicator) %>% group_modify(~ ccdf(.x$freq_urls)) %>% arrange(x) %>% 
  mutate(y = lag(y, default = 1)) %>% ungroup()# %>% mutate(x = x + 1)

plot_stat <- ks.test(features_all_unalterd %>% dplyr::filter(qIndicator == "QAnon") %>% pull(freq_urls), 
                     features_all_unalterd %>% dplyr::filter(qIndicator != "QAnon") %>% pull(freq_urls)) %>% 
  tidy() %>% mutate(label = ifelse(p.value < 0.01, paste0("KS-test: D=", round(statistic, 3), ", p<0.01"),                                                             
                                   paste0("KS-test: D=", round(statistic, 3), ", p<", format(round(p.value, digits = 2), nsmall = 2))))

plot_ccdf <- ggplot(df_plot, aes(x = x, y = y, group=qIndicator)) + geom_line(aes(group = qIndicator, color=qIndicator, linetype = qIndicator), size = 1.5) +
  scale_colour_manual(values=c("#003893", "#CE1126", "#56B4E9"), labels= c("Non-QAnon", "QAnon")) +
  scale_linetype_discrete(labels= c("Non-QAnon", "QAnon")) + 
  scale_x_continuous(
    expand = c(0, 0)
  ) +
  scale_y_continuous(
    labels = c("0.001", "0.01", "0.1", "1", "10", "100"),
    trans = "log10",
    breaks = c(0.00001, 0.0001, 0.001, 0.01, 0.1, 1),
    limits = c(0.00001,1),
    expand = c(0, 0)
  )  +
   annotate(geom = "text", x = 0.32, y = 0.0000175, label = plot_stat$label, parse = F, size = 8) +
   labs(y = "CCDF (%)", x = "URLs") + 
   theme(plot.margin=grid::unit(c(5,7,2,5), "mm"))

plot_ccdf
ggsave(plot_ccdf, file = str_c(path_figures, "freq_urls_ccdf.pdf"), width = 20, height = 15, units = "cm")

```

## CCDF: Sentiment

```{r, include = FALSE}

df_plot <- features_all_unalterd %>% group_by(qIndicator) %>% group_modify(~ ccdf(.x$user_sentiment)) %>% arrange(x) %>% 
  mutate(y = lag(y, default = 1)) %>% ungroup()# %>% mutate(x = x + 1)

plot_stat <- ks.test(features_all_unalterd %>% dplyr::filter(qIndicator == "QAnon") %>% pull(user_sentiment), 
                     features_all_unalterd %>% dplyr::filter(qIndicator != "QAnon") %>% pull(user_sentiment)) %>% 
  tidy() %>% mutate(label = ifelse(p.value < 0.01, paste0("KS-test: D=", round(statistic, 3), ", p<0.01"),                                                             
                                   paste0("KS-test: D=", round(statistic, 3), ", p<", format(round(p.value, digits = 2), nsmall = 2))))

plot_ccdf <- ggplot(df_plot, aes(x = x, y = y, group=qIndicator)) + geom_line(aes(group = qIndicator, color=qIndicator, linetype = qIndicator), size = 1.5) +
  scale_colour_manual(values=c("#003893", "#CE1126", "#56B4E9"), labels= c("Non-QAnon", "QAnon")) +
  scale_linetype_discrete(labels= c("Non-QAnon", "QAnon")) + 
  scale_x_continuous(
    limits = c(-1, 3),
    expand = c(0, 0)
      ) +
  scale_y_continuous(
    labels = c("0.001", "0.01", "0.1", "1", "10", "100"),
    trans = "log10",
    breaks = c(0.00001, 0.0001, 0.001, 0.01, 0.1, 1),
    limits = c(0.00001,1),
    expand = c(0, 0)
  )  +
  annotate(geom = "text", x = 0.3, y = 0.0000175, label = plot_stat$label, parse = F, size = 8) +
  labs(y = "CCDF (%)", x = "Sentiment") + 
  theme(plot.margin=grid::unit(c(5,7,2,5), "mm"))

plot_ccdf
ggsave(plot_ccdf, file = str_c(path_figures, "sentiment_user_ccdf.pdf"), width = 20, height = 15, units = "cm")

```

## Violin Plot

# Account Age

```{r}

df_plot <- features_all_unalterd %>%
  select(qIndicator, account_age) %>%
  mutate(qAnon = factor(qIndicator, labels = c("Non-QAnon", "QAnon")))

plot_stat <- ks.test(features_all_unalterd %>% dplyr::filter(qIndicator == "QAnon") %>% pull(account_age), 
                     features_all_unalterd %>% dplyr::filter(qIndicator != "QAnon") %>% pull(account_age)) %>% 
  tidy() %>% mutate(label = ifelse(p.value < 0.01, paste0("KS-test: D=", round(statistic, 3), ", p<0.01"),                                                             
                                   paste0("KS-test: D=", round(statistic, 3), ", p<", format(round(p.value, digits = 2), nsmall = 2))))

# Boxplot
plot_box <- ggplot(df_plot, aes(x = qAnon, y = account_age, fill = qAnon)) +
  geom_violin(color="black") +
  geom_errorbar(stat = "summary",
                fun.min = function(z) {quantile(z,0.25)},
                fun.max = function(z) {quantile(z,0.75)}, width = 0.05,
                color="white",
                width = 1.5) +
  geom_point(stat = "summary",
             fun = median,
             color = "white") +
  scale_fill_manual(values=c("#003893", "#CE1126", "#56B4E9"), labels= c("Non-QAnon", "QAnon")) +
  theme_bw() +
  theme(
    legend.position = "none"
  ) +
  theme(axis.text.x=element_text(colour = "black", size=24, vjust=0.5), 
          axis.text.y=element_text(colour = "black", size=24, vjust=0.5),
          axis.title.x=element_text(size=24), 
          axis.title.y=element_text(size=24, vjust=1.5)
    ) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  ylab("Account age") +
  xlab("")

plot_box
ggsave(plot_box, file = str_c(path_figures, "account_age_violin.pdf"), width = 20, height = 15, units = "cm")

```

### Bio

#### Overall

```{r, include = FALSE}

# Word counts (Overall)
user_count <- user_bio_qanon %>%
  count(token, sort = TRUE) %>%
  top_n(10)

# Word clouds (Overall)
user_wc <- wordcloud(user_count$token, user_count$n, max.words = 100)

# Bar graphs (Overall)
user_bar <- user_count %>%
  top_n(10) %>%
  ggplot(aes(x = fct_reorder(token, n), y = n)) +
  geom_col() +
  coord_flip() +
  theme_bw() +
  xlab("Count") +
  ylab("Term")
ggsave(str_c("./../doc/figures/", "user_bar", ".pdf"))

```

#### QAnon vs. Non-Qanon

```{r, include = FALSE}

# Word counts (QAnon vs. Non-Qanon)
user_count_by_qanon <- user_bio_qanon %>%
  group_by(user_id) %>%
  mutate(qAnon = ifelse(sum(qIndicator) == 0, 0, 1),
         qAnon = factor(qAnon, levels = c(0,1), labels = c("Non-QAnon", "QAnon"))) %>%
  group_by(qAnon) %>%
  count(token, sort = TRUE) %>%
  top_n(10)

user_count_by_qanon %>%
  top_n(10) %>%
  t()

# Table word counts by group (QAnon vs. Non-Qanon)
user_count_table <- user_count_by_qanon %>%
  slice_max(order_by = n, n = 3) %>%
  group_split() %>%
  map_dfc(identity)

# Word clouds (QAnon vs. Non-Qanon)
user_wc_by_qanon <- user_count_by_qanon %>%
  group_by(qAnon) %>%
  group_split() %>%
  map(~ wordcloud(words = .x$token, freq = .x$n, max.words = 100))

# Bar graphs (QAnon vs. Non-Qanon)
user_bar_by_qanon <- user_count_by_qanon %>%
  group_by(qAnon) %>%
  top_n(3) %>%
  ungroup %>%
  mutate(token = reorder_within(token, n, qAnon)) %>%
  ggplot(aes(x = token, y = n)) +
  facet_wrap(vars(qAnon), scales = "free") +
  geom_col() +
  coord_flip() +
  theme_bw() +
  scale_x_reordered() +
  xlab("Count") +
  ylab("Term")
ggsave(str_c(path_figures, "user_bar_by_qanon", ".pdf"))

```

# Content 
### QAnon vs. Non-Qanon

```{r, include = FALSE}

clean_annotation <- function(path_input, file_name){
  # Read files
  dta <- read_rds(str_c(path_input, file_name))
  
  # Clean file
  dta_clean <- dta %>%
    filter(!str_detect(token, pattern = "@")) %>%
    mutate(token = str_remove(token, pattern = "#")) %>%
    anti_join(stop, by = c("token" = "word")) %>%
    left_join(user_qanon, by = "creator") %>%
    group_by(comment_id) %>%
    mutate(qAnon = ifelse(sum(qIndicator) == 0, 0, 1),
         qAnon = factor(qAnon, levels = c(0,1), labels = c("Non-QAnon", "QAnon"))) %>%
    group_by(qAnon) %>%
    count(token, sort = TRUE) #%>%
    #top_n(100)
  
  # Save cleaned file
  write_rds(dta_clean, file = str_c(path_output, "words/", "words_", parse_number(file_name), ".RDS"))
  
  rm(dta, dta_clean)
}

# Clean files
list.files(path = str_c(path_output, "annotation/"), pattern = "*RDS") files_missing%>%
  future_map(~ clean_annotation(path_input = str_c(path_output, "annotation/"), file_name = .x)) 

words_count <- list.files(path = str_c(path_output, "words/"), pattern = "*RDS") %>%
  future_map_dfr(~ read_rds(str_c(path_output,"words/", .x))) %>%
  group_by(qAnon, token) %>%
  summarize(total = sum(n)) %>%
  arrange(desc(total))

write_rds(words, file = "words_count.RDS")

```

# Visualization: Frequency words

```{r plots, include=FALSE, echo=FALSE}

# Barplot (QAnon vs. Non-Qanon)
df_plot <- words_count %>%
  group_by(qAnon) %>%
  top_n(10) %>%
  ungroup %>%
  mutate(token = reorder_within(token, total, qAnon))

my_breaks <- function(x) { if (max(x) < 500000) seq(0, 500000, 100000) else seq(0, 13000000, 1000000) }
my_labels <- function(x) { if (max(x, na.rm = TRUE) < 500000) c(0, "100K", rep("", 2), "400K", "") else c("0", rep("", 4), "5Mio", rep("", 4), "10Mio", rep("",3)) }

bar_plot <- ggplot(data = df_plot, aes(x = token, y = total, fill = qAnon)) +
  facet_wrap(vars(qAnon), scales = "free") +
  geom_col(width = 0.8) +
  scale_fill_manual(values=c("#003893", "#CE1126", "#56B4E9"), labels= c("Non-QAnon", "QAnon")) +
  scale_alpha_manual(c(0.5, 0.5)) +
  coord_flip() +
  scale_x_reordered() +
  scale_y_continuous(
    breaks = my_breaks,
    labels = my_labels
    #breaks = c(0, seq(100000, 900000, by = 100000), 1000000, seq(2000000, 13000000, by = 1000000)),
    #labels = c(0, "100K", rep("", 3), "500K", rep("", 4) , "1Mio", rep("", 3), "5Mio", rep("", 4), "10Mio", rep("",3))
    ) +
  theme_bw() +
  theme(
    legend.position = "none"
  ) +
  xlab("") +
  ylab("")
ggsave(str_c(path_figures, "content_bar_by_qanon", ".pdf"), width = 15, height = 10, units = "cm")

```
